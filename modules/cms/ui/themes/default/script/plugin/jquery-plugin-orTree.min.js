import $ from "../jquery-global.min.js";
import Workbench from "../openrat/workbench.min.js";
import Notice    from "../openrat/notice.min.js";
export default function(options)
{
let settings = $.extend( {
'openAction' : function(name,action,id) {
}
}, options);
let registerTreeBranchEvents = function (viewEl)
{
Workbench.getInstance().registerDraggable(viewEl);
}
$(this).each(function (idxx, treeEl)
{
$(treeEl).children('.or-navtree-node-control').click( function ()
{
let $node = $(this).parent('.or-navtree-node');
if ($node.is('.or-navtree-node--is-open')) {
$node.children('ul').remove();
$node.removeClass('navtree-node--is-open').addClass('navtree-node--is-closed').find('.or-navtree-tree-icon').removeClass('image-icon--node-open').addClass('image-icon--node-closed');
}
else {
Workbench.getInstance().startSpinner();
let $link   = $node.find('a');
let id      = $link.data('id');
let extraId = Workbench.htmlDecode($link.data('extra'));
let loadBranchUrl = './?action=tree&subaction=branch&id=' + id + '';
if (typeof extraId === 'string')
extraId = JSON.parse(extraId);
if (typeof extraId === 'object') {
Object.keys(extraId).forEach( (name)=> {
loadBranchUrl = loadBranchUrl + '&' + name + '=' + extraId[name];
});
}
else {
;
}
console.debug( { url:loadBranchUrl } );
fetch( loadBranchUrl )
.then( response => { if (!response.ok) throw "Failed to load tree"; return response } )
.then( response => response.text() )
.then( html => {
let $ul = $.create('ul' ).addClass('navtree-list');
$(treeEl).append($ul);
$ul.html( html );
$ul.find('li').orTree(settings); 
registerTreeBranchEvents($ul);
$ul.find('.or-act-clickable').orLinkify( {
'openAction':settings.openAction
} );
//$ul.slideDown('fast'); 
}).catch( cause => {
console.error( {message:'Failed to load subtree',url:loadBranchUrl,cause:cause});
let notice = new Notice();
notice.setStatus( 'error' );
notice.msg = cause;
}).finally( () => {
Workbench.getInstance().stopSpinner();
});
$node.addClass('navtree-node--is-open').removeClass('navtree-node--is-closed').find('.or-navtree-tree-icon').addClass('image-icon--node-open').removeClass('image-icon--node-closed');
}
});
});
};